import time
import random
from utils import clear_screen, print_header, Colors, get_input
from progress_tracker import add_xp

def cve_lookup_sim():
    clear_screen()
    print_header("SIMULASI CVE LOOKUP")
    software = get_input("Masukkan Nama Software (contoh: Apache, WordPress, OpenSSL): ")
    
    print(f"\n{Colors.CYAN}Mencari kerentanan untuk {software} di database...{Colors.ENDC}\n")
    time.sleep(1.5)
    
    cve_db = {
        "apache": [
            {"id": "CVE-2021-41773", "desc": "Path Traversal and File Disclosure", "score": 7.5},
            {"id": "CVE-2019-0211", "desc": "Privilege Escalation", "score": 7.8}
        ],
        "wordpress": [
            {"id": "CVE-2022-21661", "desc": "SQL Injection in WP_Query", "score": 8.0},
            {"id": "CVE-2020-25213", "desc": "File Manager Plugin RCE", "score": 9.8}
        ],
        "openssl": [
            {"id": "CVE-2014-0160", "desc": "Heartbleed Information Disclosure", "score": 7.5},
            {"id": "CVE-2022-3602", "desc": "X.509 Email Address Buffer Overflow", "score": 8.8}
        ]
    }
    
    results = cve_db.get(software.lower(), [])
    if results:
        for bug in results:
            color = Colors.FAIL if bug['score'] >= 9.0 else Colors.WARNING
            print(f"{Colors.BOLD}{bug['id']}{Colors.ENDC}")
            print(f"Deskripsi: {bug['desc']}")
            print(f"Skor CVSS: {color}{bug['score']}{Colors.ENDC}\n")
            time.sleep(0.5)
    else:
        print(f"{Colors.FAIL}Tidak ditemukan kerentanan publik untuk {software}.{Colors.ENDC}")
        
    add_xp(30)
    input(f"\n{Colors.WARNING}Tekan ENTER untuk kembali...{Colors.ENDC}")

def vuln_scanner_sim():
    clear_screen()
    print_header("SIMULASI VULNERABILITY SCANNER")
    target = get_input("Masukkan IP Target untuk dipindai: ")
    
    print(f"\n{Colors.CYAN}Memulai pemindaian kerentanan pada {target}...{Colors.ENDC}")
    print("Mencocokkan layanan dengan database exploit...\n")
    
    scans = [
        {"port": 22, "service": "SSH", "version": "OpenSSH 7.2p2", "vuln": "User Enumeration (CVE-2018-15473)"},
        {"port": 80, "service": "HTTP", "version": "Apache 2.4.49", "vuln": "Path Traversal (CVE-2021-41773)"},
        {"port": 3306, "service": "MySQL", "version": "MySQL 5.5.x", "vuln": "None Found"}
    ]
    
    for s in scans:
        print(f"Scanning Port {s['port']} ({s['service']})...", end="\r")
        time.sleep(1)
        if s['vuln'] != "None Found":
            print(f"{Colors.FAIL}[!] {s['service']} {s['version']}: {s['vuln']}{Colors.ENDC}")
        else:
            print(f"{Colors.GREEN}[+] {s['service']} {s['version']}: Aman{Colors.ENDC}")
            
    print(f"\n{Colors.BLUE}Pemindaian Selesai.{Colors.ENDC}")
    add_xp(50)
    input(f"\n{Colors.WARNING}Tekan ENTER untuk kembali...{Colors.ENDC}")

def cvss_calculator_sim():
    clear_screen()
    print_header("CVSS SCORE CALCULATOR")
    print("Tentukan tingkat keparahan bug Anda.\n")
    
    print("1. Attack Vector (AV): [N]etwork, [A]djacent, [L]ocal, [P]hysical")
    av = get_input("Pilihan (N/A/L/P): ").upper()
    
    print("\n2. Privileges Required (PR): [N]one, [L]ow, [H]igh")
    pr = get_input("Pilihan (N/L/H): ").upper()
    
    # Kalkulasi skor sederhana (hanya simulasi)
    base_score = 0.0
    if av == 'N': base_score += 5.0
    if pr == 'N': base_score += 4.8
    
    base_score = min(base_score, 10.0)
    
    color = Colors.FAIL if base_score >= 9.0 else Colors.WARNING
    print(f"\n{Colors.BOLD}Estimasi Skor CVSS: {color}{base_score:.1f}{Colors.ENDC}")
    
    if base_score >= 9.0: print("Kategori: CRITICAL")
    elif base_score >= 7.0: print("Kategori: HIGH")
    else: print("Kategori: MEDIUM/LOW")
    
    add_xp(20)
    input(f"\n{Colors.WARNING}Tekan ENTER untuk kembali...{Colors.ENDC}")

def vulnerability_menu():
    while True:
        clear_screen()
        print_header("VULNERABILITY SCANNING & ANALYSIS LAB")
        print("1. Simulasi CVE Lookup")
        print("2. Simulasi Vulnerability Scanner")
        print("3. CVSS Score Calculator")
        print("4. Kembali ke Menu Utama")
        
        choice = get_input("\nPilihan Anda (1-4): ")
        if choice == '1':
            cve_lookup_sim()
        elif choice == '2':
            vuln_scanner_sim()
        elif choice == '3':
            cvss_calculator_sim()
        elif choice == '4':
            break
